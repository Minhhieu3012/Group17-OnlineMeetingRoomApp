<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HPH Meeting ¬∑ Ph√≤ng h·ªçp</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:#1a1a1a; color:#fff; height:100vh; display:flex; flex-direction:column; overflow:hidden;
    }
    .header{
      background:rgba(0,0,0,.8); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08)
    }
    .room-info h1{font-size:1.5rem;color:#667eea}
    .room-info p{font-size:.9rem;color:#ccc}
    .header-controls{display:flex;gap:1rem;align-items:center}
    .time-display{background:rgba(255,255,255,.1);padding:.5rem 1rem;border-radius:20px;font-weight:600}
    .participants-count{background:rgba(102,126,234,.3);padding:.5rem 1rem;border-radius:20px}

    .video-grid{
      flex:1; display:grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr));
      gap:1rem; padding:1rem; overflow-y:auto;
    }
    .video-container{position:relative;background:#2a2a2a;border-radius:15px;overflow:hidden;aspect-ratio:16/9;box-shadow:0 10px 30px rgba(0,0,0,.3);transition:.3s}
    .video-container:hover{transform:translateY(-5px); box-shadow:0 15px 40px rgba(0,0,0,.4)}
    .video-container.main{grid-column:1 / -1; max-height:60vh}
    .video-element{width:100%;height:100%;object-fit:cover;background:#333;display:none}
    .video-placeholder{
      width:100%; height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column;
      background:linear-gradient(135deg,#667eea 0%, #764ba2 100%); font-size:3rem
    }
    .video-overlay{position:absolute;left:0;right:0;bottom:0;background:linear-gradient(transparent,rgba(0,0,0,.8));padding:1rem;display:flex;justify-content:space-between;align-items:center}
    .user-name{font-weight:600;font-size:1.1rem}
    .user-status{display:flex;gap:.5rem}
    .status-icon{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem}
    .mic-status{background:#28a745}
    .mic-status.muted{background:#dc3545}
    .camera-status{background:#007bff}
    .camera-status.off{background:#6c757d}

    .controls{
      background:rgba(0,0,0,.9); padding:1.2rem; display:flex; justify-content:center; gap:1rem; backdrop-filter:blur(15px);
      border-top:1px solid rgba(255,255,255,.1)
    }
    .control-btn{
      padding:1rem;border:none;border-radius:50%;cursor:pointer;font-size:1.5rem;width:60px;height:60px;display:flex;align-items:center;justify-content:center;transition:.25s;font-weight:600
    }
    .control-btn:hover{transform:translateY(-3px); box-shadow:0 10px 20px rgba(0,0,0,.3)}
    .mic-btn{background:#28a745;color:#fff}.mic-btn.muted{background:#dc3545}
    .camera-btn{background:#007bff;color:#fff}.camera-btn.off{background:#6c757d}
    .screen-btn{background:#17a2b8;color:#fff}.screen-btn.sharing{background:#ffc107;color:#000}
    .chat-btn{background:#6f42c1;color:#fff}
    .settings-btn{background:#6c757d;color:#fff}
    .end-call-btn{background:#dc3545;color:#fff}

    .sidebar{
      position:fixed; right:0; top:0; width:350px; height:100vh; background:rgba(0,0,0,.95); backdrop-filter:blur(20px);
      transform:translateX(100%); transition:transform .3s; display:flex; flex-direction:column; border-left:1px solid rgba(255,255,255,.1); z-index:50
    }
    .sidebar.open{transform:translateX(0)}
    .sidebar-header{padding:1rem;border-bottom:1px solid rgba(255,255,255,.1);display:flex;justify-content:space-between;align-items:center}
    .close-sidebar{background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
    .sidebar-content{flex:1;overflow-y:auto;padding:1rem}
    .participant-list{display:flex;flex-direction:column;gap:.5rem}
    .participant-item{background:rgba(255,255,255,.08);padding:1rem;border-radius:10px;display:flex;align-items:center;gap:1rem}
    .participant-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%, #764ba2 100%);display:flex;align-items:center;justify-content:center;font-weight:600}
    .participant-info{flex:1}.participant-name{font-weight:600}.participant-status{font-size:.8rem;color:#ccc}

    .chat-area{flex:1;display:flex;flex-direction:column;gap:1rem;margin-top:1rem}
    .chat-messages{flex:1;background:rgba(255,255,255,.05);border-radius:10px;padding:1rem;overflow-y:auto;max-height:300px}
    .chat-message{margin-bottom:1rem;padding:.5rem;background:rgba(255,255,255,.08);border-radius:8px}
    .message-author{font-weight:600;font-size:.8rem;color:#667eea;margin-bottom:.25rem}
    .chat-input-area{display:flex;gap:.5rem}
    .chat-input-area input{flex:1;padding:.5rem;border:1px solid rgba(255,255,255,.2);border-radius:5px;background:rgba(255,255,255,.1);color:#fff}
    .chat-input-area input::placeholder{color:rgba(255,255,255,.5)}
    .chat-input-area button{padding:.5rem 1rem;border:none;background:#667eea;color:#fff;border-radius:5px;cursor:pointer}

    .notification{
      position:fixed; top:20px; right:20px; background:rgba(0,0,0,.9); color:#fff; padding:1rem; border-radius:10px; border:1px solid rgba(255,255,255,.2);
      z-index:1000; animation:slideInRight .3s ease
    }
    @keyframes slideInRight{from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1}}

    .loading{
      position:fixed; inset:0; background:rgba(0,0,0,.8); display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:2000
    }
    .loading-spinner{width:50px;height:50px;border:5px solid rgba(255,255,255,.3);border-top:5px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1rem}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    @media (max-width: 768px){
      .video-grid{grid-template-columns:1fr}
      .sidebar{width:100%}
      .controls{padding:1rem;gap:.5rem}
      .control-btn{width:50px;height:50px;font-size:1.2rem}
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <div>ƒêang thi·∫øt l·∫≠p cu·ªôc g·ªçi...</div>
  </div>

  <div class="header">
    <div class="room-info">
      <h1 id="roomName">Ph√≤ng h·ªçp</h1>
      <p id="roomDescription">Video call ƒëang ho·∫°t ƒë·ªông</p>
    </div>
    <div class="header-controls">
      <div class="time-display" id="callDuration">00:00</div>
      <div class="participants-count" id="participantCount">1 ng∆∞·ªùi</div>
    </div>
  </div>

  <div class="video-grid" id="videoGrid">
    <div class="video-container main" id="localVideoContainer">
      <video id="localVideo" class="video-element" muted autoplay playsinline></video>
      <div class="video-placeholder" id="localPlaceholder">
        <div>üë§</div>
        <div style="font-size:1rem;margin-top:.5rem">Camera ch∆∞a b·∫≠t</div>
      </div>
      <div class="video-overlay">
        <div class="user-name" id="localUserName">B·∫°n</div>
        <div class="user-status">
          <div class="status-icon mic-status" id="localMicStatus">üé§</div>
          <div class="status-icon camera-status" id="localCameraStatus">üìπ</div>
        </div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="control-btn mic-btn" id="micBtn" title="B·∫≠t/t·∫Øt micro">üé§</button>
    <button class="control-btn camera-btn" id="cameraBtn" title="B·∫≠t/t·∫Øt camera">üìπ</button>
    <button class="control-btn screen-btn" id="screenBtn" title="Chia s·∫ª m√†n h√¨nh">üñ•Ô∏è</button>
    <button class="control-btn chat-btn" id="chatBtn" title="M·ªü chat">üí¨</button>
    <button class="control-btn settings-btn" id="settingsBtn" title="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
    <button class="control-btn end-call-btn" id="endBtn" title="K·∫øt th√∫c cu·ªôc g·ªçi">üìû</button>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>Th√¥ng tin cu·ªôc g·ªçi</h3>
      <button class="close-sidebar" id="closeSidebar">√ó</button>
    </div>
    <div class="sidebar-content">
      <div class="sidebar-section">
        <h4 style="margin-bottom:1rem">Ng∆∞·ªùi tham gia</h4>
        <div class="participant-list" id="participantList"></div>
      </div>

      <div class="sidebar-section" id="chatSection" style="display:none">
        <h4 style="margin:1rem 0">Chat</h4>
        <div class="chat-area">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
            <button id="sendChat">G·ª≠i</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { ensureCredsOrRedirect, connectAndLogin, getRoom, setRoom } from './common.js';

    // ---------- State ----------
    const $ = (s)=>document.querySelector(s);
    const creds = ensureCredsOrRedirect(); if(!creds) throw new Error('No creds');
    let room = getRoom() || new URLSearchParams(location.search).get('room') || 'default';
    setRoom(room);
    let ws = null;
    let localStream = null;
    let micEnabled = false, camEnabled = false, screenSharing = false;
    const participants = new Map(); // username -> {element}

    // ---------- UI Boot ----------
    $('#localUserName').textContent = creds.username;
    $('#roomName').textContent = 'Ph√≤ng: ' + room;

    // ---------- Helpers ----------
    function showNotification(text){
      const n = document.createElement('div');
      n.className = 'notification';
      n.textContent = text;
      document.body.append(n);
      setTimeout(()=>n.remove(), 2000);
    }
    function updateParticipantCount(){
      const count = participants.size + 1; // + local
      $('#participantCount').textContent = count + ' ng∆∞·ªùi';
    }
    function addChatMessage(author, text){
      const box = $('#chatMessages');
      const item = document.createElement('div');
      item.className = 'chat-message';
      item.innerHTML = '<div class="message-author">'+author+'</div><div>'+text+'</div>';
      box.append(item);
      box.scrollTop = box.scrollHeight;
    }
    function renderParticipantList(users){
      const box = $('#participantList'); box.innerHTML = '';
      users.forEach(u=>{
        const row = document.createElement('div');
        row.className = 'participant-item';
        row.innerHTML = `
          <div class="participant-avatar">${(u.username||'?').slice(0,2).toUpperCase()}</div>
          <div class="participant-info">
            <div class="participant-name">${u.username}</div>
            <div class="participant-status">${u.username===creds.username?'B·∫°n':'ƒêang tham gia'}</div>
          </div>`;
        box.append(row);
      });
    }
    function ensureRemoteTile(username){
      if(username === creds.username || participants.has(username)) return;
      const vc = document.createElement('div');
      vc.className = 'video-container';
      vc.id = 'participant-'+username;
      vc.innerHTML = `
        <div class="video-placeholder"><div>üë§</div><div style="font-size:1rem;margin-top:.5rem;">Camera ch∆∞a b·∫≠t</div></div>
        <video class="video-element" autoplay playsinline></video>
        <div class="video-overlay">
          <div class="user-name">${username}</div>
          <div class="user-status">
            <div class="status-icon mic-status">üé§</div>
            <div class="status-icon camera-status">üìπ</div>
          </div>
        </div>`;
      $('#videoGrid').append(vc);
      participants.set(username, { element: vc });
      updateParticipantCount();
    }
    function removeRemoteTile(username){
      const p = participants.get(username);
      if(p){ p.element.remove(); participants.delete(username); updateParticipantCount(); }
    }
    function setLocalVideoVisible(on){
      const v = $('#localVideo'), ph = $('#localPlaceholder');
      v.style.display = on ? 'block' : 'none';
      ph.style.display = on ? 'none' : 'flex';
    }
    function updateLocalIndicators(){
      $('#localMicStatus').classList.toggle('muted', !micEnabled);
      $('#localCameraStatus').classList.toggle('off', !camEnabled);
      $('#micBtn').classList.toggle('muted', !micEnabled);
      $('#cameraBtn').classList.toggle('off', !camEnabled);
    }
    function broadcastMediaState(){
      ws && ws.send(JSON.stringify({ type:'media_state', micEnabled, cameraEnabled: camEnabled }));
    }

    // ---------- Media ----------
    async function initMedia(){
      try{
        localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        $('#localVideo').srcObject = localStream;
        camEnabled = true; micEnabled = true;
        setLocalVideoVisible(true);
        updateLocalIndicators();
      }catch(err){
        console.log('Media denied:', err);
        showNotification('Kh√¥ng th·ªÉ truy c·∫≠p camera/micro');
        camEnabled = false; micEnabled = false;
        setLocalVideoVisible(false);
        updateLocalIndicators();
      }
    }
    async function toggleCamera(){
      if(!localStream){
        await initMedia();
        broadcastMediaState();
        return;
      }
      const vTrack = localStream.getVideoTracks()[0];
      if(camEnabled){
        if(vTrack){ vTrack.stop(); localStream.removeTrack(vTrack); }
        camEnabled = false; setLocalVideoVisible(false);
      }else{
        try{
          const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
          const nt = s.getVideoTracks()[0];
          localStream.addTrack(nt);
          $('#localVideo').srcObject = localStream;
          camEnabled = true; setLocalVideoVisible(true);
        }catch(e){ showNotification('Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera'); }
      }
      updateLocalIndicators(); broadcastMediaState();
    }
    function toggleMic(){
      if(!localStream){ showNotification('Ch∆∞a b·∫≠t micro/camera'); return; }
      const aTrack = localStream.getAudioTracks()[0];
      if(aTrack){ aTrack.enabled = !aTrack.enabled; micEnabled = aTrack.enabled; }
      updateLocalIndicators(); broadcastMediaState();
    }
    let screenStream = null;
    async function toggleScreenShare(){
      if(!screenSharing){
        try{
          screenStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
          $('#localVideo').srcObject = screenStream;
          screenSharing = true; $('#screenBtn').classList.add('sharing');
        }catch(e){ /* user cancelled */ }
      }else{
        if(screenStream){ screenStream.getTracks().forEach(t=>t.stop()); screenStream = null; }
        $('#localVideo').srcObject = localStream || null;
        screenSharing = false; $('#screenBtn').classList.remove('sharing');
      }
    }

    // ---------- Call duration ----------
    function startTimer(){
      const start = Date.now();
      setInterval(()=>{
        const s = Math.floor((Date.now()-start)/1000);
        const mm = String(Math.floor(s/60)).padStart(2,'0');
        const ss = String(s%60).padStart(2,'0');
        $('#callDuration').textContent = `${mm}:${ss}`;
      }, 1000);
    }

    // ---------- WebSocket / Protocol ----------
    function onLoginOk(msg){
      ws.send(JSON.stringify({ type:'join_room', room }));
    }
    function onMessage(msg){
      switch(msg.type){
        case 'join_room':
          // users: [{username}, ...]
          if(Array.isArray(msg.users)){ renderParticipantList(msg.users); msg.users.forEach(u=>ensureRemoteTile(u.username)); }
          $('#loading').style.display='none';
          break;
        case 'user_list':
          if(Array.isArray(msg.users)){ renderParticipantList(msg.users); }
          break;
        case 'user_joined':
          ensureRemoteTile(msg.user || msg.username); showNotification(`${msg.user||msg.username} ƒë√£ v√†o ph√≤ng`);
          break;
        case 'user_left':
          removeRemoteTile(msg.user || msg.username); showNotification(`${msg.user||msg.username} ƒë√£ r·ªùi ph√≤ng`);
          break;
        case 'chat':
          addChatMessage(msg.from || 'Ng∆∞·ªùi d√πng', msg.message ?? (msg.payload && msg.payload.text) ?? '');
          break;
        case 'media_state': {
          const name = msg.from || msg.username;
          const p = participants.get(name); if(!p) return;
          const mic = p.element.querySelector('.mic-status');
          const cam = p.element.querySelector('.camera-status');
          const st = msg.payload || msg;
          if(mic) mic.classList.toggle('muted', !st.micEnabled);
          if(cam) cam.classList.toggle('off', !st.cameraEnabled);
          break;
        }
        default: /* ignore */ break;
      }
    }
    function onClose(){ showNotification('M·∫•t k·∫øt n·ªëi t·ªõi server'); }

    // ---------- Boot ----------
    (async ()=>{
      await initMedia();
      ws = connectAndLogin(creds, { onLoginOk, onMessage, onClose });
      startTimer();
      $('#loading').style.display='none';
    })();

    // ---------- Controls & Sidebar ----------
    $('#micBtn').addEventListener('click', toggleMic);
    $('#cameraBtn').addEventListener('click', toggleCamera);
    $('#screenBtn').addEventListener('click', toggleScreenShare);
    $('#chatBtn').addEventListener('click', ()=>{ $('#sidebar').classList.add('open'); $('#chatSection').style.display='block'; });
    $('#closeSidebar').addEventListener('click', ()=> $('#sidebar').classList.remove('open'));
    $('#settingsBtn').addEventListener('click', ()=> alert('C√†i ƒë·∫∑t s·∫Ω b·ªï sung sau.'));
    $('#endBtn').addEventListener('click', ()=>{
      ws && ws.send(JSON.stringify({ type:'leave_room' }));
      try{ localStream && localStream.getTracks().forEach(t=>t.stop()); }catch(_){}
      location.href = 'lobby.html';
    });

    // Chat
    $('#sendChat').addEventListener('click', ()=>{
      const t = $('#chatInput').value.trim(); if(!t) return;
      ws && ws.send(JSON.stringify({ type:'chat', message: t }));
      addChatMessage(creds.username, t);
      $('#chatInput').value='';
    });
    $('#chatInput').addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#sendChat').click(); }});
  </script>
</body>
</html>
